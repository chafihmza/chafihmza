generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

enum Role {
  ADMIN
  MANAGER
  USER
}

enum ConnectorProtocol {
  SFTP
  FTP
  FTPS
}

model User {
  id           String         @id @default(uuid())
  name         String
  email        String         @unique
  passwordHash String         @map("password_hash")
  role         Role
  isActive     Boolean        @default(true) @map("is_active")
  createdAt    DateTime       @default(now()) @map("created_at")
  connectors   Connector[]    @relation("ConnectorCreatedBy")
  permissions  ConnectorPermission[]
  refreshTokens RefreshToken[]
  auditLogs    AuditLog[]

  @@map("users")
}

model Connector {
  id             String               @id @default(uuid())
  name           String
  protocol       ConnectorProtocol
  host           String
  port           Int
  username       String
  secretEncrypted String             @map("secret_encrypted")
  secretIv       String             @map("secret_iv")
  secretTag      String             @map("secret_tag")
  privateKeyEncrypted String?        @map("private_key_encrypted")
  privateKeyIv    String?            @map("private_key_iv")
  privateKeyTag   String?            @map("private_key_tag")
  basePath       String             @map("base_path")
  createdById    String             @map("created_by")
  createdAt      DateTime           @default(now()) @map("created_at")
  createdBy      User               @relation("ConnectorCreatedBy", fields: [createdById], references: [id])
  permissions    ConnectorPermission[]
  auditLogs      AuditLog[]

  @@map("connectors")
}

model ConnectorPermission {
  id          String    @id @default(uuid())
  connectorId String    @map("connector_id")
  userId      String    @map("user_id")
  canRead     Boolean   @default(true) @map("can_read")
  canWrite    Boolean   @default(false) @map("can_write")
  connector   Connector @relation(fields: [connectorId], references: [id])
  user        User      @relation(fields: [userId], references: [id])

  @@unique([connectorId, userId])
  @@map("connector_permissions")
}

model AuditLog {
  id          String   @id @default(uuid())
  userId      String?  @map("user_id")
  connectorId String?  @map("connector_id")
  action      String
  path        String?
  metaJson    Json?    @map("meta_json")
  ip          String
  status      String
  createdAt   DateTime @default(now()) @map("created_at")
  user        User?    @relation(fields: [userId], references: [id])
  connector   Connector? @relation(fields: [connectorId], references: [id])

  @@map("audit_logs")
}

model RefreshToken {
  id        String   @id @default(uuid())
  userId    String   @map("user_id")
  tokenHash String   @map("token_hash")
  expiresAt DateTime @map("expires_at")
  revokedAt DateTime? @map("revoked_at")
  createdAt DateTime @default(now()) @map("created_at")
  user      User     @relation(fields: [userId], references: [id])

  @@map("refresh_tokens")
}
